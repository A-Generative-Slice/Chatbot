// AI-Powered Multilingual Sales Bot with Hugging Face
// Smart, Persuasive, Natural Responses in Tamil, Hindi, Telugu, Kannada, English

const express = require('express');
const bodyParser = require('body-parser');
const { MessagingResponse } = require('twilio').twiml;
const { HfInference } = require('@huggingface/inference');
const natural = require('natural');
const fuzzysort = require('fuzzysort');
const fs = require('fs');

const app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

const PORT = process.env.PORT || 3000;

// Initialize Hugging Face with multiple models
const HF_TOKEN = process.env.HUGGINGFACE_TOKEN || null;
const hf = HF_TOKEN ? new HfInference(HF_TOKEN) : null;

// AI Model Configuration
const AI_MODELS = {
  sales: 'google/gemma-2-2b-it',              // Primary: Persuasive sales responses
  translation: 'facebook/mbart-large-50-many-to-many-mmt',  // Multilingual translation
  indic: 'ai4bharat/indic-bart',              // Indian languages specialist
  fallback: 'meta-llama/Llama-3.2-1B-Instruct' // Backup model
};

// Load product data
let productsData = {};
let knowledgeData = {};
let productSearchIndex = [];

try {
  productsData = JSON.parse(fs.readFileSync('products.json', 'utf8'));
  console.log('‚úÖ Loaded products.json');
  
  // Build search index
  const categories = productsData.categories || {};
  for (const [categoryKey, categoryData] of Object.entries(categories)) {
    const categoryName = categoryData.name || categoryKey;
    for (const product of categoryData.products || []) {
      productSearchIndex.push({
        ...product,
        category: categoryName,
        searchText: `${product.name} ${categoryName} ${product.description || ''} ${product.keywords?.join(' ') || ''}`.toLowerCase()
      });
    }
  }
  console.log(`‚úÖ Indexed ${productSearchIndex.length} products for AI-powered search`);
} catch (error) {
  console.log('‚ùå Error loading products.json:', error.message);
}

try {
  knowledgeData = JSON.parse(fs.readFileSync('products_knowledge_enhanced.json', 'utf8'));
  console.log('‚úÖ Loaded enhanced knowledge base');
} catch (error) {
  console.log('‚ö†Ô∏è Knowledge base not found (optional)');
}

// AI Response cache (to save API calls)
const aiResponseCache = new Map();
const MAX_CACHE_SIZE = 500;

// User session management
const userSessions = new Map();

// Multilingual system messages
const systemMessages = {
  en: {
    welcome: "üåü *Welcome to Rose Chemicals!*\n\nI'm your AI shopping assistant! ü§ñ\n\nI can help you:\n‚ú® Find perfect products\nüí¨ Answer questions\nüéØ Give recommendations\nüåç Chat in your language\n\nPlease select your language:",
    languageMenu: "üåê *Choose Language:*\n\n1Ô∏è‚É£ English\n2Ô∏è‚É£ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)\n3Ô∏è‚É£ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)\n4Ô∏è‚É£ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)\n5Ô∏è‚É£ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)\n6Ô∏è‚É£ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)\n\nReply with number (1-6)",
    greeting: "üëã Hello! I'm your AI sales assistant!\n\nüí° *I can help you with:*\n‚Ä¢ Product recommendations\n‚Ä¢ Best deals and offers\n‚Ä¢ Cleaning solutions for any need\n‚Ä¢ Bulk orders and pricing\n\nWhat are you looking for today?",
    thinking: "ü§î Let me find the perfect solution for you..."
  },
  ta: {
    greeting: "üëã ‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç AI ‡Æµ‡Æø‡Æ±‡Øç‡Æ™‡Æ©‡Øà ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç!\n\nüí° *‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç:*\n‚Ä¢ ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øç\n‚Ä¢ ‡Æö‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡ØÅ ‡Æö‡Æ≤‡ØÅ‡Æï‡Øà‡Æï‡Æ≥‡Øç\n‚Ä¢ ‡Æé‡Æ®‡Øç‡Æ§ ‡Æ§‡Øá‡Æµ‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡Æ§‡ØÄ‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç\n‚Ä¢ ‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÜ‡Æ∞‡Øç‡Æü‡Æ∞‡Øç‡Æï‡Æ≥‡Øç\n\n‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æé‡Æ©‡Øç‡Æ© ‡Æ§‡Øá‡Æµ‡Øà?",
    thinking: "ü§î ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ§‡ØÄ‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æ§‡Øá‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç..."
  },
  hi: {
    greeting: "üëã ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ AI ‡§∏‡•á‡§≤‡•ç‡§∏ ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•Ç‡§Å!\n\nüí° *‡§Æ‡•à‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å:*\n‚Ä¢ ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§∏‡•Å‡§ù‡§æ‡§µ\n‚Ä¢ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ë‡§´‡§∞‡•ç‡§∏\n‚Ä¢ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§´‡§æ‡§à ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®\n‚Ä¢ ‡§•‡•ã‡§ï ‡§ë‡§∞‡•ç‡§°‡§∞\n\n‡§Ü‡§ú ‡§Ü‡§™‡§ï‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?",
    thinking: "ü§î ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡•Ä ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§¢‡•Ç‡§Ç‡§¢ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å..."
  },
  te: {
    greeting: "üëã ‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç! ‡∞®‡±á‡∞®‡±Å ‡∞Æ‡±Ä AI ‡∞∏‡±á‡∞≤‡±ç‡∞∏‡±ç ‡∞Ö‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡±Ü‡∞Ç‡∞ü‡±ç!\n\nüí° *‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å:*\n‚Ä¢ ‡∞â‡∞§‡±ç‡∞§‡∞Æ ‡∞â‡∞§‡±ç‡∞™‡∞§‡±ç‡∞§‡∞ø ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å\n‚Ä¢ ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡±á‡∞ï ‡∞Ü‡∞´‡∞∞‡±ç‡∞≤‡±Å\n‚Ä¢ ‡∞è ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞æ‡∞®‡∞ø‡∞ï‡±à‡∞®‡∞æ ‡∞∂‡±Å‡∞≠‡±ç‡∞∞‡∞§ ‡∞™‡∞∞‡∞ø‡∞∑‡±ç‡∞ï‡∞æ‡∞∞‡∞æ‡∞≤‡±Å\n‚Ä¢ ‡∞¨‡∞≤‡±ç‡∞ï‡±ç ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å\n\n‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞Æ‡±Ä‡∞ï‡±Å ‡∞è‡∞Æ‡∞ø ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞ø?",
    thinking: "ü§î ‡∞Æ‡±Ä ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∏‡∞∞‡±à‡∞® ‡∞™‡∞∞‡∞ø‡∞∑‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç ‡∞µ‡±Ü‡∞§‡±Å‡∞ï‡±Å‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å..."
  },
  kn: {
    greeting: "üëã ‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! ‡≤®‡≤æ‡≤®‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ AI ‡≤Æ‡≤æ‡≤∞‡≤æ‡≤ü ‡≤∏‡≤π‡≤æ‡≤Ø‡≤ï!\n\nüí° *‡≤®‡≤æ‡≤®‡≥Å ‡≤∏‡≤π‡≤æ‡≤Ø ‡≤Æ‡≤æ‡≤°‡≤¨‡≤≤‡≥ç‡≤≤‡≥Ü:*\n‚Ä¢ ‡≤Ö‡≤§‡≥ç‡≤Ø‡≥Å‡≤§‡≥ç‡≤§‡≤Æ ‡≤â‡≤§‡≥ç‡≤™‡≤®‡≥ç‡≤® ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å\n‚Ä¢ ‡≤µ‡≤ø‡≤∂‡≥á‡≤∑ ‡≤ï‡≥ä‡≤°‡≥Å‡≤ó‡≥Ü‡≤ó‡≤≥‡≥Å\n‚Ä¢ ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤Ö‡≤ó‡≤§‡≥ç‡≤Ø‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤∂‡≥Å‡≤ö‡≤ø‡≤ó‡≥ä‡≤≥‡≤ø‡≤∏‡≥Å‡≤µ ‡≤™‡≤∞‡≤ø‡≤π‡≤æ‡≤∞‡≤ó‡≤≥‡≥Å\n‚Ä¢ ‡≤¨‡≥É‡≤π‡≤§‡≥ç ‡≤Ü‡≤∞‡≥ç‡≤°‡≤∞‡≥ç‚Äå‡≤ó‡≤≥‡≥Å\n\n‡≤á‡≤Ç‡≤¶‡≥Å ‡≤®‡≤ø‡≤Æ‡≤ó‡≥Ü ‡≤è‡≤®‡≥Å ‡≤¨‡≥á‡≤ï‡≥Å?",
    thinking: "ü§î ‡≤®‡≤ø‡≤Æ‡≤ó‡≤æ‡≤ó‡≤ø ‡≤∏‡≤∞‡≤ø‡≤Ø‡≤æ‡≤¶ ‡≤™‡≤∞‡≤ø‡≤π‡≤æ‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥á‡≤®‡≥Ü..."
  }
};

function getUserSession(phoneNumber) {
  if (!userSessions.has(phoneNumber)) {
    userSessions.set(phoneNumber, {
      language: null,
      lastActivity: new Date(),
      isFirstMessage: true,
      conversationHistory: [],
      customerProfile: {
        interests: [],
        previousProducts: [],
        priceRange: null
      }
    });
  }
  const session = userSessions.get(phoneNumber);
  session.lastActivity = new Date();
  return session;
}

// Get appropriate emoji for product
function getProductEmoji(productName) {
  const name = productName.toLowerCase();
  if (name.includes('floor')) return 'üßπ';
  if (name.includes('dish')) return 'üçΩÔ∏è';
  if (name.includes('fabric')) return 'üëï';
  if (name.includes('liquid')) return 'üß¥';
  if (name.includes('toilet')) return 'üöΩ';
  if (name.includes('brush')) return 'üßΩ';
  if (name.includes('wiper')) return 'ü™£';
  if (name.includes('mop')) return 'üß∫';
  if (name.includes('phenyl')) return 'üíß';
  if (name.includes('acid') || name.includes('chemical')) return 'üß™';
  return '‚ú®';
}

// Detect language change request
function detectLanguageChange(message) {
  const messageLower = message.toLowerCase();
  
  const languagePatterns = {
    en: ['english', 'speak english', 'change to english', 'in english', 'english please'],
    ta: ['tamil', 'tamil la', '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç', 'tamil pesu', 'change to tamil', 'in tamil'],
    hi: ['hindi', 'hindi mein', '‡§π‡§ø‡§Ç‡§¶‡•Ä', 'speak hindi', 'change to hindi', 'in hindi'],
    te: ['telugu', 'telugu lo', '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å', 'speak telugu', 'change to telugu', 'in telugu'],
    kn: ['kannada', 'kannada li', '‡≤ï‡≤®‡≥ç‡≤®‡≤°', 'speak kannada', 'change to kannada', 'in kannada'],
    ml: ['malayalam', 'malayalam il', '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç', 'speak malayalam', 'change to malayalam']
  };
  
  for (const [lang, patterns] of Object.entries(languagePatterns)) {
    if (patterns.some(pattern => messageLower.includes(pattern))) {
      return lang;
    }
  }
  
  return null;
}

// Detect if user is referring to previous message
function detectContextReference(message) {
  const messageLower = message.toLowerCase();
  
  const contextKeywords = [
    'that', 'it', 'this', 'previous', 'above', 'last one', 'same',
    'adhu', 'idhu', 'andha', 'indha', // Tamil
    'woh', 'yeh', 'uska', 'iska', // Hindi
    'adi', 'idi', 'aa', 'ee', // Telugu
    'adu', 'idu', 'aa', 'ii' // Kannada
  ];
  
  return contextKeywords.some(kw => messageLower.includes(kw));
}

// Detect intent with enhanced NLP
function detectIntent(message) {
  const messageLower = message.toLowerCase();
  
  // Keywords for each intent
  const intents = {
    greeting: ['hi', 'hello', 'hey', 'good morning', 'good evening', 'vanakkam', 'namaste', 'namaskara'],
    search: ['show', 'find', 'search', 'looking for', 'need', 'want', 'kaanum', 'dheko', 'chaupandi'],
    price: ['price', 'cost', 'rate', 'how much', 'vilai', 'daam', 'bele'],
    recommendation: ['best', 'recommend', 'suggest', 'good', 'better', 'sirappu', 'accha', 'chennagide'],
    question: ['what', 'how', 'why', 'when', 'enna', 'kya', 'yenu'],
    objection: ['expensive', 'costly', 'cheap', 'budget', 'doubt', 'not sure'],
    purchase: ['buy', 'order', 'purchase', 'cart', 'vaangu', 'khareed', 'kolo']
  };
  
  let bestIntent = 'general';
  let maxScore = 0;
  
  for (const [intent, keywords] of Object.entries(intents)) {
    const score = keywords.filter(kw => messageLower.includes(kw)).length;
    if (score > maxScore) {
      maxScore = score;
      bestIntent = intent;
    }
  }
  
  return { intent: bestIntent, confidence: maxScore > 0 ? 85 : 50 };
}

// Smart product search with fuzzy matching
function smartSearch(query, maxResults = 5) {
  const results = fuzzysort.go(query, productSearchIndex, {
    keys: ['name', 'searchText', 'description'],
    threshold: -10000,
    limit: maxResults
  });
  
  return results.map(r => r.obj);
}

// Generate AI-powered sales response
async function generateAISalesResponse(query, products, language, session) {
  if (!hf) {
    console.log('‚ö†Ô∏è HF token not set, using enhanced templates');
    return generateEnhancedTemplate(query, products, language);
  }
  
  // Check cache first
  const cacheKey = `${query}_${products[0]?.id}_${language}`;
  if (aiResponseCache.has(cacheKey)) {
    console.log('üéØ Using cached AI response');
    return aiResponseCache.get(cacheKey);
  }
  
  try {
    const product = products[0];
    
    // Build conversation history for context
    const recentHistory = session.conversationHistory.slice(-4).map(h => 
      `${h.role === 'user' ? 'Customer' : 'You'}: ${h.content}`
    ).join('\n');
    
    // Build context from product data
    const productContext = `
Product: ${product.name}
Price: ‚Çπ${product.mrp}
Description: ${product.description || 'Quality cleaning product'}
Key Benefits: ${product.uses?.slice(0, 3).join(', ') || 'Effective cleaning'}
Popularity: ${product.search_metadata?.popularity_score || 75}/100
${product.search_metadata?.trending ? 'Status: TRENDING NOW!' : ''}
`;
    
    // Create persuasive sales prompt with conversation context
    const salesPrompt = `You are an expert sales assistant for Rose Chemicals. 

${recentHistory ? 'Recent conversation:\n' + recentHistory + '\n\n' : ''}Customer's current question: "${query}"
${productContext}

Generate a natural, persuasive response in English that:
1. References the conversation context if relevant
2. Acknowledges their need warmly
3. Highlights 2-3 KEY BENEFITS (not features)
4. Emphasizes VALUE and QUALITY
5. Creates subtle urgency (popular item, good price, etc.)
6. Sounds friendly and helpful (not pushy)
7. Keeps it under 80 words

Response:`;

    console.log('ü§ñ Calling AI for sales response...');
    
    // Use chatCompletion for gemma model
    const response = await hf.chatCompletion({
      model: AI_MODELS.sales,
      messages: [
        { role: "user", content: salesPrompt }
      ],
      max_tokens: 120,
      temperature: 0.8
    });
    
    let salesText = response.choices[0].message.content.trim();
    
    // Translate if not English
    if (language !== 'en') {
      const langMap = { ta: 'Tamil', hi: 'Hindi', te: 'Telugu', kn: 'Kannada', ml: 'Malayalam' };
      const targetLang = langMap[language];
      
      if (targetLang) {
        console.log(`üåç Translating to ${targetLang}...`);
        
        try {
          const translated = await hf.translation({
            model: 'facebook/mbart-large-50-many-to-many-mmt',
            inputs: salesText,
            parameters: {
              src_lang: 'en_XX',
              tgt_lang: language === 'ta' ? 'ta_IN' : language === 'hi' ? 'hi_IN' : language === 'te' ? 'te_IN' : language === 'kn' ? 'kn_IN' : 'ml_IN'
            }
          });
          
          salesText = translated.translation_text || salesText;
        } catch (transError) {
          console.log('‚ö†Ô∏è Translation failed, keeping English');
        }
      }
    }
    
    // Format with emojis and structure
    const emoji = getProductEmoji(product.name);
    let formatted = `${emoji} ${salesText}\n\nüí∞ *Price: ‚Çπ${product.mrp}*`;
    
    // Add urgency indicator if popular
    if (product.search_metadata?.popularity_score > 85) {
      formatted += `\n\nüî• *Best seller - ${Math.floor(Math.random() * 300) + 200}+ sold this month!*`;
    } else if (product.search_metadata?.featured) {
      formatted += `\n\n‚≠ê *Customer favorite!*`;
    }
    
    // Add related products
    if (products.length > 1) {
      formatted += `\n\nüì¶ *Also check:*`;
      products.slice(1, 3).forEach((p, i) => {
        formatted += `\n${i + 2}. ${p.name} (‚Çπ${p.mrp})`;
      });
    }
    
    // Cache the response
    if (aiResponseCache.size >= MAX_CACHE_SIZE) {
      const firstKey = aiResponseCache.keys().next().value;
      aiResponseCache.delete(firstKey);
    }
    aiResponseCache.set(cacheKey, formatted);
    
    return formatted;
    
  } catch (error) {
    console.error('‚ùå AI generation error:', error.message);
    return generateEnhancedTemplate(query, products, language);
  }
}

// Enhanced template fallback (when AI unavailable)
function generateEnhancedTemplate(query, products, language) {
  const product = products[0];
  const emoji = getProductEmoji(product.name);
  
  const templates = {
    en: {
      intro: ['Perfect choice!', 'Great selection!', 'Excellent pick!', 'Smart choice!'],
      value: ['Amazing value for money', 'Best quality at this price', 'Our most popular item', 'Customer favorite'],
      action: ['Want to order?', 'Ready to buy?', 'Shall I add to cart?']
    },
    ta: {
      intro: ['‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ!', '‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ!', '‡Æ®‡Æ≤‡Øç‡Æ≤ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ!'],
      value: ['‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ', '‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ§‡Æ∞‡ÆÆ‡Øç', '‡ÆÆ‡Æø‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æø‡Æ∞‡Æ™‡Æ≤‡ÆÆ‡Ææ‡Æ© ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç'],
      action: ['‡ÆÜ‡Æ∞‡Øç‡Æü‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ≤‡Ææ‡ÆÆ‡Ææ?', '‡Æµ‡Ææ‡Æô‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?']
    },
    hi: {
      intro: ['‡§™‡§∞‡§´‡•á‡§ï‡•ç‡§ü ‡§ö‡•ç‡§µ‡§æ‡§á‡§∏!', '‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ ‡§ö‡•Å‡§®‡§æ‡§µ!', '‡§∂‡§æ‡§®‡§¶‡§æ‡§∞!'],
      value: ['‡§™‡•à‡§∏‡•á ‡§ï‡§æ ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç', '‡§á‡§∏ ‡§ï‡•Ä‡§Æ‡§§ ‡§Æ‡•á‡§Ç ‡§¨‡•á‡§∏‡•ç‡§ü ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä', '‡§∏‡§¨‡§∏‡•á ‡§™‡•â‡§™‡•Å‡§≤‡§∞ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü'],
      action: ['‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç?', '‡§ñ‡§∞‡•Ä‡§¶‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?']
    },
    te: {
      intro: ['‡∞∏‡∞∞‡±à‡∞® ‡∞é‡∞Ç‡∞™‡∞ø‡∞ï!', '‡∞ó‡±ä‡∞™‡±ç‡∞™ ‡∞é‡∞Ç‡∞™‡∞ø‡∞ï!', '‡∞Ö‡∞¶‡±ç‡∞≠‡±Å‡∞§‡∞Ç!'],
      value: ['‡∞°‡∞¨‡±ç‡∞¨‡±Å‡∞ï‡±Å ‡∞Ö‡∞¶‡±ç‡∞≠‡±Å‡∞§‡∞Æ‡±à‡∞® ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ', '‡∞à ‡∞ß‡∞∞‡∞≤‡±ã ‡∞â‡∞§‡±ç‡∞§‡∞Æ ‡∞®‡∞æ‡∞£‡±ç‡∞Ø‡∞§', '‡∞Ö‡∞§‡±ç‡∞Ø‡∞Ç‡∞§ ‡∞™‡±ç‡∞∞‡∞ú‡∞æ‡∞¶‡∞∞‡∞£ ‡∞™‡±ä‡∞Ç‡∞¶‡∞ø‡∞® ‡∞â‡∞§‡±ç‡∞™‡∞§‡±ç‡∞§‡∞ø'],
      action: ['‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞æ?', '‡∞ï‡±ä‡∞®‡±Å‡∞ó‡±ã‡∞≤‡±Å ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡∞æ?']
    },
    kn: {
      intro: ['‡≤∏‡≤∞‡≤ø‡≤Ø‡≤æ‡≤¶ ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü!', '‡≤Ö‡≤¶‡≥ç‡≤≠‡≥Å‡≤§ ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü!', '‡≤â‡≤§‡≥ç‡≤§‡≤Æ!'],
      value: ['‡≤π‡≤£‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤Ö‡≤¶‡≥ç‡≤≠‡≥Å‡≤§ ‡≤Æ‡≥å‡≤≤‡≥ç‡≤Ø', '‡≤à ‡≤¨‡≥Ü‡≤≤‡≥Ü‡≤ó‡≥Ü ‡≤â‡≤§‡≥ç‡≤§‡≤Æ ‡≤ó‡≥Å‡≤£‡≤Æ‡≤ü‡≥ç‡≤ü', '‡≤Ö‡≤§‡≥ç‡≤Ø‡≤Ç‡≤§ ‡≤ú‡≤®‡≤™‡≥ç‡≤∞‡≤ø‡≤Ø ‡≤â‡≤§‡≥ç‡≤™‡≤®‡≥ç‡≤®'],
      action: ['‡≤Ü‡≤∞‡≥ç‡≤°‡≤∞‡≥ç ‡≤Æ‡≤æ‡≤°‡≤¨‡≥á‡≤ï‡≥á?', '‡≤ñ‡≤∞‡≥Ä‡≤¶‡≤ø‡≤∏‡≤≤‡≥Å ‡≤¨‡≤Ø‡≤∏‡≥Å‡≤µ‡≤ø‡≤∞‡≤æ?']
    }
  };
  
  const lang = templates[language] || templates.en;
  const intro = lang.intro[Math.floor(Math.random() * lang.intro.length)];
  const value = lang.value[Math.floor(Math.random() * lang.value.length)];
  
  let response = `${emoji} *${intro}*\n\n`;
  response += `${product.name}\n`;
  response += `${product.description || ''}\n\n`;
  
  if (product.uses && product.uses.length > 0) {
    response += `‚úÖ ${product.uses[0]}\n`;
    if (product.uses[1]) response += `‚úÖ ${product.uses[1]}\n`;
  }
  
  response += `\nüí∞ *‚Çπ${product.mrp}*\n`;
  response += `${value}!`;
  
  if (product.search_metadata?.popularity_score > 85) {
    response += `\n\nüî• *Trending now!*`;
  }
  
  return response;
}

// Handle incoming messages
async function handleMessage(message, session) {
  // Check for language change request
  const newLanguage = detectLanguageChange(message);
  if (newLanguage) {
    session.language = newLanguage;
    const langNames = {
      en: 'English',
      ta: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)',
      hi: '‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)',
      te: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)',
      kn: '‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)',
      ml: '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)'
    };
    return `‚úÖ Language changed to ${langNames[newLanguage]}!\n\n${systemMessages[newLanguage]?.greeting || systemMessages.en.greeting}`;
  }
  
  const intent = detectIntent(message);
  console.log(`üß† Intent: ${intent.intent} (${intent.confidence}%)`);
  
  // Check if user is referring to previous context
  const hasContextReference = detectContextReference(message);
  if (hasContextReference && session.conversationHistory.length > 0) {
    // Get last product mentioned
    const lastBotMessage = session.conversationHistory.slice().reverse().find(h => h.role === 'bot');
    if (lastBotMessage && lastBotMessage.products && lastBotMessage.products.length > 0) {
      console.log('üîó User referring to previous product');
      const lang = session.language || 'en';
      const response = await generateAISalesResponse(message, lastBotMessage.products, lang, session);
      session.conversationHistory.push({ role: 'bot', content: response, products: lastBotMessage.products });
      return response;
    }
  }
  
  // Update conversation history
  session.conversationHistory.push({ role: 'user', content: message });
  if (session.conversationHistory.length > 10) {
    session.conversationHistory = session.conversationHistory.slice(-10);
  }
  
  const lang = session.language || 'en';
  
  // Handle different intents
  if (intent.intent === 'greeting') {
    return systemMessages[lang]?.greeting || systemMessages.en.greeting;
  }
  
  if (intent.intent === 'search' || intent.intent === 'recommendation' || intent.intent === 'general') {
    // Search for products
    const products = smartSearch(message, 5);
    
    if (products.length === 0) {
      return `${systemMessages[lang]?.thinking || 'ü§î'}\n\nSorry, I couldn't find exact matches. Can you describe what you're looking for? (floor cleaner, dish wash, etc.)`;
    }
    
    // Generate AI-powered sales response
    const response = await generateAISalesResponse(message, products, lang, session);
    
    // Store products in conversation history
    session.conversationHistory.push({ role: 'bot', content: response, products: products });
    
    return response;
  }
  
  if (intent.intent === 'price') {
    const products = smartSearch(message, 3);
    if (products.length > 0) {
      let response = `üí∞ *Pricing:*\n\n`;
      products.forEach((p, i) => {
        response += `${i + 1}. ${p.name}\n   ‚Çπ${p.mrp}\n\n`;
      });
      session.conversationHistory.push({ role: 'bot', content: response, products: products });
      return response;
    }
  }
  
  // Default: try AI-powered response
  const products = smartSearch(message, 3);
  if (products.length > 0) {
    const response = await generateAISalesResponse(message, products, lang, session);
    session.conversationHistory.push({ role: 'bot', content: response, products: products });
    return response;
  }
  
  // No products found - provide helpful message
  const helpMessages = {
    en: "I couldn't find products matching that. Try:\n‚Ä¢ 'floor cleaner'\n‚Ä¢ 'dish wash'\n‚Ä¢ 'bathroom cleaner'\n‚Ä¢ 'show all products'",
    ta: "‡ÆÖ‡Æ®‡Øç‡Æ§ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:\n‚Ä¢ '‡Æ§‡Æ∞‡Øà ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç'\n‚Ä¢ '‡Æ™‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç ‡Æï‡Æ¥‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æø‡Æ∞‡Æµ‡ÆÆ‡Øç'\n‚Ä¢ '‡Æï‡ØÅ‡Æ≥‡Æø‡ÆØ‡Æ≤‡Æ±‡Øà ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç'",
    hi: "‡§µ‡§π ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç:\n‚Ä¢ '‡§´‡§∞‡•ç‡§∂ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞'\n‚Ä¢ '‡§¨‡§∞‡•ç‡§§‡§® ‡§∏‡§æ‡§´ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§æ‡§¨‡•Å‡§®'\n‚Ä¢ '‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞'",
    te: "‡∞Ü ‡∞â‡∞§‡±ç‡∞™‡∞§‡±ç‡∞§‡∞ø ‡∞¶‡±ä‡∞∞‡∞ï‡∞≤‡±á‡∞¶‡±Å. ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø:\n‚Ä¢ '‡∞´‡±ç‡∞≤‡±ã‡∞∞‡±ç ‡∞ï‡±ç‡∞≤‡±Ä‡∞®‡∞∞‡±ç'\n‚Ä¢ '‡∞°‡∞ø‡∞∑‡±ç ‡∞µ‡∞æ‡∞∑‡±ç'\n‚Ä¢ '‡∞¨‡∞æ‡∞§‡±ç‡∞∞‡±Ç‡∞Æ‡±ç ‡∞ï‡±ç‡∞≤‡±Ä‡∞®‡∞∞‡±ç'",
    kn: "‡≤Ü ‡≤â‡≤§‡≥ç‡≤™‡≤®‡≥ç‡≤® ‡≤∏‡≤ø‡≤ó‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø:\n‚Ä¢ '‡≤´‡≥ç‡≤≤‡≥ã‡≤∞‡≥ç ‡≤ï‡≥ç‡≤≤‡≥Ä‡≤®‡≤∞‡≥ç'\n‚Ä¢ '‡≤°‡≤ø‡≤∂‡≥ç ‡≤µ‡≤æ‡≤∂‡≥ç'\n‚Ä¢ '‡≤¨‡≤æ‡≤§‡≥ç‡≤∞‡≥Ç‡≤Æ‡≥ç ‡≤ï‡≥ç‡≤≤‡≥Ä‡≤®‡≤∞‡≥ç'"
  };
  
  return helpMessages[lang] || helpMessages.en;
}

// WhatsApp webhook endpoint
app.post('/whatsapp', async (req, res) => {
  const incomingMessage = req.body.Body?.trim() || '';
  const phoneNumber = req.body.From || '';
  
  console.log(`\nüì± Message from ${phoneNumber}: "${incomingMessage}"`);
  
  const twiml = new MessagingResponse();
  const session = getUserSession(phoneNumber);
  
  try {
    let replyMessage = '';
    
    // First time user
    if (session.isFirstMessage) {
      session.isFirstMessage = false;
      replyMessage = systemMessages.en.welcome + '\n\n' + systemMessages.en.languageMenu;
    }
    // Language selection
    else if (!session.language && /^[1-6]$/.test(incomingMessage)) {
      const langMap = { '1': 'en', '2': 'ta', '3': 'te', '4': 'kn', '5': 'ml', '6': 'hi' };
      session.language = langMap[incomingMessage];
      replyMessage = systemMessages[session.language]?.greeting || systemMessages.en.greeting;
    }
    // Regular conversation
    else {
      if (!session.language) session.language = 'en';
      replyMessage = await handleMessage(incomingMessage, session);
    }
    
    // Log the response being sent
    console.log(`üì§ Sending response (${replyMessage.length} chars):`);
    console.log(`Preview: ${replyMessage.substring(0, 100)}...`);
    
    twiml.message(replyMessage);
    console.log(`‚úÖ Reply sent (${replyMessage.length} chars)`);
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    console.error('Stack:', error.stack);
    twiml.message('Sorry, I encountered an error. Please try again! üôè');
  }
  
  res.type('text/xml');
  res.send(twiml.toString());
});

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    aiEnabled: !!hf,
    productsIndexed: productSearchIndex.length,
    cacheSize: aiResponseCache.size,
    activeSessions: userSessions.size
  });
});

// Start server
app.listen(PORT, () => {
  console.log('\nüöÄ AI-Powered Multilingual Sales Bot Starting...');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log(`üåê Server running on port ${PORT}`);
  console.log(`üîó Local URL: http://localhost:${PORT}`);
  console.log(`üì± Webhook endpoint: http://localhost:${PORT}/whatsapp`);
  console.log(`ü§ñ AI Status: ${hf ? '‚úÖ ENABLED' : '‚ö†Ô∏è  DISABLED (set HUGGINGFACE_TOKEN)'}`);
  console.log(`üìä Products indexed: ${productSearchIndex.length}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üéØ AI Models:');
  console.log(`   ‚Ä¢ Sales: ${AI_MODELS.sales}`);
  console.log(`   ‚Ä¢ Translation: ${AI_MODELS.indic}`);
  console.log(`   ‚Ä¢ Languages: Tamil, Hindi, Telugu, Kannada, Malayalam, English`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  if (!hf) {
    console.log('üí° To enable AI:');
    console.log('   1. Get token: https://huggingface.co/settings/tokens');
    console.log('   2. Set: $env:HUGGINGFACE_TOKEN="hf_xxx"');
    console.log('   3. Restart: npm run start:ai');
  }
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üéØ Ready to provide intelligent sales assistance!\n');
});
